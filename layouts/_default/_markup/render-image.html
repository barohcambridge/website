{{/*
  Adapted from:
    https://rb.ax/blog/perfect-image-processing-with-hugo/
    https://its.mw/posts/hugo-responsive-images/
*/}}

{{/* Image width break points */}}
{{- $widths := slice "420" "789" "1019" "1430" "2048" -}}

{{/* Parse Markdown alt text and title */}}
{{- $alt := .Text -}}
{{- $label := .Text -}}
{{- $caption := "" -}}
{{- if ne .Title "" -}}
  {{- $caption = .Title | $.Page.RenderString -}}
  {{- $label = $caption -}}
{{- end -}}

{{/* Locate source image file */}}
{{- $image := resources.Get .Destination -}}
{{- if not $image -}}
  {{- errorf "Missing image %q" .Destination -}}
{{- end -}}

{{/* Construct image(s) */}}
{{- $gradient_style := false -}}
{{- if $image -}}
  {{- $gradient_colours := $image.Colors -}}
  {{- $gradient := delimit ($gradient_colours) ", " -}}
  {{- $gradient_style = print "background:linear-gradient(" $gradient ");" -}}
{{- end -}}

{{/* Render image */}}
<figure role="figure" aria-label="{{- $label | plainify -}}">
  <div class="image-wrapper"
    {{ with $gradient_style }}
      {{ printf "style=%q" $gradient_style | safeHTMLAttr }}
    {{ end }}>
    {{ partial "image.html" (dict
      "image" $image
      "alt" $caption
      "title" $label) }}
  </div>
  {{ with $caption }}
    <figcaption>{{ $caption }}</figcaption>
  {{ end }}
</figure>
